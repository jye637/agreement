<form id="consentForm">
  <label><input type="checkbox" id="agree"> 我同意</label>
  <label>請輸入身分證號後5碼：<input type="text" id="idLast5" maxlength="5"></label>
  <label>請簽名：</label>
  <canvas id="signatureCanvas" width="400" height="150" style="border:1px solid #ccc;"></canvas>
  <button type="submit">送出資料</button>
</form>
<p id="status"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  storageBucket: "signup-f163b.appspot.com",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Canvas 簽名
const canvas = document.getElementById("signatureCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;

canvas.addEventListener("mousedown", e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
canvas.addEventListener("mousemove", e => { if(drawing){ ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);

document.getElementById("consentForm").addEventListener("submit", async e => {
  e.preventDefault();

  const agree = document.getElementById("agree").checked;
  const idLast5 = document.getElementById("idLast5").value.trim();
  if(!agree){ alert("請勾選同意"); return; }
  if(idLast5.length !== 5){ alert("請輸入正確的身分證後5碼"); return; }

  const timestamp = new Date().toLocaleString();
  const dataUrl = canvas.toDataURL();
  const fileName = `signatures/${idLast5}_${Date.now()}.png`;
  const storageRef = ref(storage, fileName);

  try {
    await uploadString(storageRef, dataUrl, "data_url");
    const signatureUrl = await getDownloadURL(storageRef);

    await addDoc(collection(db, "signatures"), {
      agree,
      idLast5,
      signatureUrl,
      timestamp: serverTimestamp()
    });

    document.getElementById("status").innerText = `我們已經收到您的同意書了 (${timestamp})`;
    document.getElementById("agree").checked = false;
    document.getElementById("idLast5").value = "";
    ctx.clearRect(0,0,canvas.width,canvas.height);
  } catch(err) {
    console.error(err);
    alert("送出失敗，請稍後再試");
  }
});
</script>
