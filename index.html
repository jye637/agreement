<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>114-12蔡文國小-資通安全保密同意書</title>

<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #eef2f3;
  padding: 20px;
}

.container {
  max-width: 850px;
  margin: 0 auto;
  background: #ffffff;
  padding: 35px;
  border-radius: 12px;
  box-shadow: 0 0 12px rgba(0,0,0,0.12);
}

h1 {
  text-align: center;
  color: #0d6b27;
  margin-bottom: 20px;
}

label {
  display: block;
  margin-top: 15px;
  font-size: 17px;
}

input[type="text"] {
  padding: 8px 10px;
  width: 180px;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-left: 5px;
}

.flex-row {
  display: flex;
  align-items: center;
  gap: 15px;
}

button {
  margin-top: 20px;
  padding: 12px 25px;
  background: #0d6b27;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
}
button:hover { background: #094b1c; }

#clearBtn {
  background: #aa0000;
}
#clearBtn:hover {
  background: #770000;
}

canvas {
  border: 2px solid #888;
  margin-top: 10px;
  border-radius: 5px;
}

#status {
  color: #0d6b27;
  font-weight: bold;
  margin-top: 20px;
  font-size: 18px;
}

.signature-display img {
  border: 1px solid #ccc;
  margin-top: 10px;
  width: 350px;
  border-radius: 8px;
}
</style>
</head>

<body>
<div class="container">

<h1>蔡文國民小學資通安全保密同意書</h1>

<p>依據本校資訊安全維護計畫要求全校教職員簽署資通保密同意書如下：</p>

<ol>
  <li>於業務上所知悉之機敏資料及運用之資通系統等，應善盡保管及保密之責。</li>
  <li>相關業務之資訊、文件，不得私自洩漏與業務無關之人員。</li>
  <li>使用即時通訊軟體傳遞機關內部公務訊息，其內容不得涉及機密資料。</li>
  <li>遵守本單位資通安全相關之法令及規定。</li>
  <li>如有危害本單位資通安全之行為，願負相關之責任。</li>
</ol>

<p>相關問題或疑義請洽教務處資訊組，07-6076268#723</p>

<form id="consentForm">

  <!-- 同意 + 姓名 -->
  <div class="flex-row">
    <label><input type="checkbox" id="agree"> 我同意</label>
    <label>姓名：<input type="text" id="username" placeholder="請輸入姓名"></label>
  </div>

  <label>身分證後 5 碼：
    <input type="text" id="idLast5" maxlength="5" placeholder="例如：12345">
  </label>

  <label>簽名：</label>
  <canvas id="signatureCanvas" width="500" height="200"></canvas>

  <button type="button" id="clearBtn">清除簽名</button>
  <button type="submit">送出資料</button>

</form>

<p id="status"></p>
<div class="signature-display" id="signatureDisplay"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Canvas 簽名
const canvas = document.getElementById("signatureCanvas");
const ctx = canvas.getContext("2d");
ctx.lineWidth = 2;
let drawing = false;

canvas.addEventListener("mousedown", e => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("mousemove", e => {
  if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
});
canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);

// 清除簽名
document.getElementById("clearBtn").addEventListener("click", () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
});

// 檢查是否簽名（空白畫布比較）
function isCanvasBlank(canvas) {
  const blank = document.createElement("canvas");
  blank.width = canvas.width;
  blank.height = canvas.height;
  return canvas.toDataURL() === blank.toDataURL();
}

// 送出事件
document.getElementById("consentForm").addEventListener("submit", async e => {
  e.preventDefault();

  const agree = document.getElementById("agree").checked;
  const username = document.getElementById("username").value.trim();
  const idLast5 = document.getElementById("idLast5").value.trim();

  if (!agree) { alert("請勾選同意"); return; }
  if (!username) { alert("請輸入姓名"); return; }
  if (idLast5.length !== 5) { alert("請輸入正確的身分證後 5 碼"); return; }
  if (isCanvasBlank(canvas)) {
    alert("請完成簽名後再送出！");
    return;
  }

  const signatureDataUrl = canvas.toDataURL();
  
  try {
    await addDoc(collection(db, "signatures"), {
      agree,
      username,
      idLast5,
      signatureDataUrl,
      timestamp: serverTimestamp()
    });

    const now = new Date().toLocaleString();

    document.getElementById("status").textContent =
      `我們已經收到「${username}」的同意書了（${now}）`;

    const displayDiv = document.getElementById("signatureDisplay");
    displayDiv.innerHTML = `
      <p>姓名：${username}</p>
      <p>身分證後 5 碼：${idLast5}</p>
      <p>簽名時間：${now}</p>
      <img src="${signatureDataUrl}" alt="簽名">
    `;

    // 清空表單
    document.getElementById("agree").checked = false;
    document.getElementById("username").value = "";
    document.getElementById("idLast5").value = "";
    ctx.clearRect(0, 0, canvas.width, canvas.height);

  } catch (error) {
    console.error(error);
    alert("送出失敗，請稍後再試");
  }
});
</script>

</div>
</body>
</html>
