<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>資安同意書管理後台</title>
<style>
body{font-family:Noto Sans TC,sans-serif;background:#f5f5f5;padding:20px;}
.container{max-width:900px;margin:0 auto;background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1{text-align:center;color:#006600;}
button{margin:5px;padding:8px 15px;background:#006600;color:#fff;border:none;border-radius:5px;cursor:pointer;}
button:hover{background:#004d00;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th, td{border:1px solid #ccc;padding:8px;text-align:center;}
#loginForm{margin-bottom:20px;}
</style>
</head>
<body>
<div class="container">
<h1>資安同意書管理後台</h1>

<div id="loginDiv">
  <p>請使用管理員帳號登入：</p>
  <form id="loginForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="密碼" required>
    <button type="submit">登入</button>
  </form>
  <p id="loginStatus"></p>
</div>

<div id="adminDiv" style="display:none;">
  <button id="logoutBtn">登出</button>
  <table>
    <thead>
      <tr>
        <th>身分證後5碼</th>
        <th>同意</th>
        <th>簽名</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="signaturesTable"></tbody>
  </table>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import jsPDF from 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginForm = document.getElementById('loginForm');
const loginStatus = document.getElementById('loginStatus');
const loginDiv = document.getElementById('loginDiv');
const adminDiv = document.getElementById('adminDiv');
const logoutBtn = document.getElementById('logoutBtn');
const signaturesTable = document.getElementById('signaturesTable');

loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
    loginStatus.textContent = "登入成功！";
  }catch(err){
    console.error(err);
    loginStatus.textContent = "登入失敗：" + err.message;
  }
});

logoutBtn.addEventListener('click', async ()=>{
  await signOut(auth);
});

onAuthStateChanged(auth, async (user)=>{
  if(user){
    loginDiv.style.display = "none";
    adminDiv.style.display = "block";
    await loadSignatures();
  }else{
    loginDiv.style.display = "block";
    adminDiv.style.display = "none";
    signaturesTable.innerHTML = "";
  }
});

async function loadSignatures(){
  signaturesTable.innerHTML = "";
  try{
    const querySnapshot = await getDocs(collection(db,"signatures"));
    querySnapshot.forEach(doc=>{
      const data = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.idLast5}</td>
        <td>${data.agree ? '同意' : '不同意'}</td>
        <td><img src="${data.signatureDataUrl}" width="150"></td>
        <td><button onclick="generatePDF('${doc.id}')">生成PDF</button></td>
      `;
      signaturesTable.appendChild(tr);
    });
  }catch(err){
    console.error(err);
    alert("讀取資料失敗：" + err.message);
  }
}

// PDF 生成
window.generatePDF = async function(docId){
  try{
    const docRef = collection(db,"signatures");
    const querySnapshot = await getDocs(docRef);
    let data = null;
    querySnapshot.forEach(doc=>{
      if(doc.id === docId) data = doc.data();
    });
    if(!data){ alert("找不到資料"); return; }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFontSize(12);
    pdf.text("蔡文國民小學資通安全保密同意書",20,20);
    pdf.text("身分證後5碼：" + data.idLast5,20,30);
    pdf.text("同意：" + (data.agree ? "同意" : "不同意"),20,40);
    pdf.text("條款如下：",20,50);
    const terms = [
      "1. 於業務上所知悉之機敏資料
