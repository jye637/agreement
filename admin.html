<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>資安同意書管理後台</title>
<style>
body { font-family: Noto Sans TC, sans-serif; padding: 20px; background: #f5f5f5; }
.container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1 { text-align:center; color:#006600; }
table { width: 100%; border-collapse: collapse; margin-top: 20px;}
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
button { padding:5px 10px; border:none; border-radius:5px; background:#006600; color:#fff; cursor:pointer; }
button:hover { background:#004d00; }
</style>
</head>
<body>
<div class="container">
<h1>114-12資安同意書管理後台</h1>
<p id="status">請登入 Firebase 以查看資料</p>
<table id="signatureTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>身分證後5碼</th>
      <th>簽名</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// 登入測試 (可以改成表單)
signInWithEmailAndPassword(auth, "jye637@tsw.kh.edu.tw", "你的密碼")
  .catch(err => alert("登入失敗：" + err.message));

onAuthStateChanged(auth, async user => {
  if(user){
    document.getElementById("status").textContent = `已登入：${user.email}`;
    loadSignatures();
  } else {
    document.getElementById("status").textContent = "請登入 Firebase";
  }
});

async function loadSignatures(){
  const tbody = document.querySelector("#signatureTable tbody");
  tbody.innerHTML = "";

  const q = query(collection(db, "signatures"), orderBy("timestamp","desc"));
  const snapshot = await getDocs(q);
  
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${doc.id}</td>
      <td>${data.idLast5 || ""}</td>
      <td><img src="${data.signatureDataUrl}" width="200"></td>
      <td><button onclick="generatePDF('${doc.id}')">PDF</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// 使用 jsPDF CDN 生成 PDF
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
async function generatePDF(docId){
  const { jsPDF } = window.jspdf;
  const docRef = firebase.firestore().collection("signatures").doc(docId);

  try {
    const docSnap = await docRef.get();
    if(!docSnap.exists){
      alert("找不到該資料");
      return;
    }
    const data = docSnap.data();
    const pdf = new jsPDF();

    // 寫入資安條款
    pdf.setFontSize(16);
    pdf.text("蔡文國民小學資通安全保密同意書", 20, 20);
    pdf.setFontSize(12);
    const clauses = [
      "1. 於業務上所知悉之機敏資料及運用之資通系統等，應善盡保管及保密之責。",
      "2. 相關業務之資訊、文件，不得私自洩漏與業務無關之人員。",
      "3. 使用即時通訊軟體傳遞機關內部公務訊息，其內容不得涉及機密資料。",
      "4. 遵守本單位資通安全相關之法令及規定。",
      "5. 如有危害本單位資通安全之行為，願負相關之責任。"
    ];
    let y = 30;
    clauses.forEach(line => { pdf.text(line, 20, y); y += 10; });

    // 加入簽名
    const img = new Image();
    img.src = data.signatureDataUrl;
    await new Promise(resolve => img.onload = resolve);
    pdf.addImage(img, 'PNG', 20, y + 10, 150, 50);

    pdf.save(`資安同意書_${data.idLast5 || docId}.pdf`);
  } catch(err){
    console.error(err);
    alert("生成 PDF 失敗: " + err.message);
  }
}
</script>
</body>
</html>
