<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理後台 - 資通安全同意書</title>
<style>
body { font-family: Noto Sans TC, sans-serif; background:#f5f5f5; padding:20px; }
.container { max-width:1000px; margin:0 auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
h1{text-align:center; color:#006600;}
table { width:100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
button { padding:5px 10px; background:#006600; color:#fff; border:none; border-radius:5px; cursor:pointer; }
button:hover { background:#004d00; }
#loginForm { max-width:400px; margin:0 auto; }
#status { color:red; font-weight:bold; margin-top:10px; text-align:center; }
</style>
</head>
<body>

<div class="container">
<h1>資通安全同意書管理後台</h1>

<!-- 登入表單 -->
<div id="loginDiv">
  <form id="loginForm">
    <label>Email: <input type="email" id="email" required></label>
    <label>密碼: <input type="password" id="password" required></label>
    <button type="submit">登入</button>
  </form>
  <p id="status"></p>
</div>

<!-- 管理員表格 -->
<div id="adminDiv" style="display:none;">
  <table id="signaturesTable">
    <thead>
      <tr>
        <th>身分證後5碼</th>
        <th>簽名</th>
        <th>時間</th>
        <th>PDF</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- jsPDF 字型 Base64 -->
<script type="text/javascript">
// Noto Sans TC Base64 字型 (簡短示例，請自行用完整字型)
const notoSansTC = "AAEAAAASAQAABAAgR0RFRgAAA..."; // 請替換成完整 Base64 字串
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

// jsPDF
import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// 登入
document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const status = document.getElementById("status");

    try {
        await signInWithEmailAndPassword(auth, email, password);
        status.textContent = "";
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("adminDiv").style.display = "block";
        loadSignatures();
    } catch(err) {
        console.error(err);
        status.textContent = "登入失敗：" + err.message;
    }
});

// 取得簽名資料
async function loadSignatures() {
    const tbody = document.querySelector("#signaturesTable tbody");
    tbody.innerHTML = "";
    const q = query(collection(db, "signatures"), orderBy("timestamp", "desc"));
    const snapshot = await getDocs(q);
    snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${data.idLast5}</td>
            <td><img src="${data.signatureDataUrl}" width="200"></td>
            <td>${data.timestamp?.toDate().toLocaleString() || ""}</td>
            <td><button onclick='generatePDF("${data.idLast5}", "${data.signatureDataUrl}")'>PDF</button></td>
        `;
        tbody.appendChild(tr);
    });
}

// 生成 PDF
window.generatePDF = (idLast5, signatureDataUrl) => {
    const pdf = new jsPDF();
    pdf.addFileToVFS("NotoSansTC.ttf", notoSansTC);
    pdf.addFont("NotoSansTC.ttf", "NotoSansTC", "normal");
    pdf.setFont("NotoSansTC");
    pdf.setFontSize(14);
    pdf.text("蔡文國民小學資通安全保密同意書", 10, 20);
    pdf.setFontSize(12);

    const content = `
依據本校資訊安全維護計畫要求全校教職員簽署資通保密同意書如下：

1. 於業務上所知悉之機敏資料及運用之資通系統等，應善盡保管及保密之責。
2. 相關業務之資訊、文件，不得私自洩漏與業務無關之人員。
3. 使用即時通訊軟體傳遞機關內部公務訊息，其內容不得涉及機密資料。
4. 遵守本單位資通安全相關之法令及規定。
5. 如有危害本單位資通安全之行為，願負相關之責任。
    `;

    const textLines = pdf.splitTextToSize(content, 180);
    pdf.text(textLines, 10, 30);

    // 加上簽名圖片
    pdf.addImage(signatureDataUrl, "PNG", 10, 110, 80, 30);

    pdf.save(`consent_${idLast5}.pdf`);
};
</script>

</div>
</body>
</html>
