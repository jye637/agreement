<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理後臺</title>
<style>
body { font-family:Noto Sans TC, sans-serif; background:#f5f5f5; padding:20px;}
h1 { text-align:center; color:#003366;}
table { width:100%; border-collapse: collapse; margin-top:20px; background:#fff;}
th, td { border:1px solid #ccc; padding:8px; text-align:center;}
th { background-color:#006600; color:white;}
img { max-width:150px; max-height:100px;}
button { margin-top:15px; padding:8px 16px; background:#006600; color:#fff; border:none; border-radius:5px; cursor:pointer;}
button:hover { background:#004d00;}
#loginForm { max-width:400px; margin:50px auto; padding:30px; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
#loginForm input { display:block; width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc;}
#content { display:none; }
</style>
</head>
<body>

<div id="loginForm">
  <h2>管理者登入</h2>
  <input type="text" id="adminEmail" placeholder="Email">
  <input type="password" id="adminPassword" placeholder="密碼">
  <button id="loginBtn">登入</button>
  <p id="loginStatus" style="color:red;"></p>
</div>

<div id="content">
<h1>資通安全同意書管理後臺</h1>
<button id="downloadPDF">下載 PDF</button>
<table id="signaturesTable">
  <thead>
    <tr>
      <th>身分證後五碼</th>
      <th>簽名</th>
      <th>送出時間</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import jsPDF from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  storageBucket: "signup-f163b.appspot.com",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_EMAIL = "jye637@tsw.kh.edu.tw";
const ADMIN_PASSWORD = "720926";

document.getElementById("loginBtn").addEventListener("click", () => {
  const email = document.getElementById("adminEmail").value.trim();
  const password = document.getElementById("adminPassword").value.trim();
  if(email === ADMIN_EMAIL && password === ADMIN_PASSWORD){
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("content").style.display = "block";
    loadSignatures();
  } else {
    document.getElementById("loginStatus").textContent = "帳號或密碼錯誤";
  }
});

const tableBody = document.querySelector("#signaturesTable tbody");

async function loadSignatures() {
  const q = query(collection(db, "signatures"), orderBy("timestamp","desc"));
  const snapshot = await getDocs(q);
  tableBody.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement("tr");

    const tdId = document.createElement("td");
    tdId.textContent = data.idLast5 || "";
    tr.appendChild(tdId);

    const tdSignature = document.createElement("td");
    const img = document.createElement("img");
    img.src = data.signatureUrl;
    tdSignature.appendChild(img);
    tr.appendChild(tdSignature);

    const tdTime = document.createElement("td");
    const date = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
    tdTime.textContent = date.toLocaleString();
    tr.appendChild(tdTime);

    tableBody.appendChild(tr);
  });
}

// PDF 下載
document.getElementById("downloadPDF").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;
  for (let row of tableBody.querySelectorAll("tr")) {
    const idText = row.cells[0].textContent;
    const signatureImg = row.cells[1].querySelector("img");
    const timeText = row.cells[2].textContent;

    pdf.text(`身分證後五碼: ${idText}`, 10, y);
    if(signatureImg) pdf.addImage(signatureImg.src, "PNG", 10, y+2, 50, 25);
    pdf.text(`送出時間: ${timeText}`, 70, y+15);
    y += 35;
    if(y > 270){ pdf.addPage(); y=10; }
  }
  pdf.save("signatures.pdf");
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
