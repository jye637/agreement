<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>114資安同意書管理後台</title>
<style>
body{font-family:Noto Sans TC,sans-serif;background:#f5f5f5;padding:20px;}
.container{max-width:900px;margin:0 auto;background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1{text-align:center;color:#006600;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
button{padding:5px 10px;margin:2px;background:#006600;color:#fff;border:none;border-radius:5px;cursor:pointer;}
button:hover{background:#004d00;}
</style>
</head>
<body>
<div class="container">
<h1>資安同意書管理後台</h1>
<p>登入帳號：<span id="userEmail"></span> <button id="logoutBtn">登出</button></p>

<table id="signaturesTable">
  <thead>
    <tr>
      <th>身分證後5碼</th>
      <th>簽名</th>
      <th>送出時間</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCk-1B0IwsSOwlNIn71-LofJRoHzgh6kJQ",
  authDomain: "signup-f163b.firebaseapp.com",
  projectId: "signup-f163b",
  messagingSenderId: "4965735888",
  appId: "1:4965735888:web:6ce33434885f967ed22dd5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const tableBody = document.querySelector("#signaturesTable tbody");
const userEmailSpan = document.getElementById("userEmail");
const logoutBtn = document.getElementById("logoutBtn");

// 登出
logoutBtn.addEventListener("click", () => signOut(auth));

// 偵測登入狀態
onAuthStateChanged(auth, async (user) => {
  if (user) {
    if(user.email !== "jye637@tsw.kh.edu.tw") {
      alert("非管理者無法進入後台");
      await signOut(auth);
      return;
    }
    userEmailSpan.textContent = user.email;
    loadSignatures();
  } else {
    try {
      await signInWithPopup(auth, provider);
    } catch(e) {
      console.error(e);
      alert("登入失敗");
    }
  }
});

// 讀取簽名資料
async function loadSignatures() {
  tableBody.innerHTML = "";
  try {
    const snapshot = await getDocs(collection(db, "signatures"));
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.idLast5}</td>
        <td><img src="${data.signatureDataUrl}" width="150"></td>
        <td>${data.timestamp ? data.timestamp.toDate().toLocaleString() : "-"}</td>
        <td><button data-id="${docSnap.id}">生成 PDF</button></td>
      `;
      tableBody.appendChild(tr);
      tr.querySelector("button").addEventListener("click", () => generatePDF(data));
    });
  } catch(e) {
    console.error(e);
    alert("讀取資料失敗，請確認 Firestore 規則與登入狀態");
  }
}

// 生成 PDF
function generatePDF(data) {
  const pdf = new jsPDF();
  const pageWidth = pdf.internal.pageSize.getWidth();
  let y = 10;
  
  pdf.setFontSize(16);
  pdf.text("蔡文國民小學資通安全保密同意書", pageWidth / 2, y, {align: "center"});
  y += 10;
  
  pdf.setFontSize(12);
  const lines = [
    "依據本校資訊安全維護計畫要求全校教職員簽署資通保密同意書如下：",
    "1. 於業務上所知悉之機敏資料及運用之資通系統等，應善盡保管及保密之責。",
    "2. 相關業務之資訊、文件，不得私自洩漏與業務無關之人員。",
    "3. 使用即時通訊軟體傳遞機關內部公務訊息，其內容不得涉及機密資料。",
    "4. 遵守本單位資通安全相關之法令及規定。",
    "5. 如有危害本單位資通安全之行為，願負相關之責任。",
    "",
    `身分證後5碼: ${data.idLast5}`
  ];
  lines.forEach(line => {
    pdf.text(line, 10, y);
    y += 7;
  });

  if (data.signatureDataUrl) {
    // 加入簽名圖片
    pdf.addImage(data.signatureDataUrl, "PNG", 10, y, 100, 50);
  }

  pdf.save(`Consent_${data.idLast5}.pdf`);
}
</script>
</body>
</html>
